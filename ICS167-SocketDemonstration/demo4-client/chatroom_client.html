<!doctype html>
<html>
<head>
	<meta charset='UTF-8' />
	<style>
		#container{
			width: 100%;
			margin: auto;
		}
		input,textarea
		{
			border:1px solid #CCC;
			width: 100px;
			height:20px;
			margin-left:0px;
			padding:0px
		}
        #ip {line-height:20px}
        #port {line-height:20px}
		#body1 {width:450px; float: left; border: 1px solid black}
		#log {width:400px;height:200px}
		#message {width:400px;height:20px}
		#myCanvas{
			width: 500px;
			height: 500px;
			background-color: white;
			border: 1px solid black;
			margin: 20px 20px;
		}
	</style>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
	<script src="fancywebsocket.js"></script>
	<script>
		
		var Server;
		var uName;
		
		var xBall=150;
		var yBall=150;
		
		var xPaddle = 20;
		var yPaddle = 0;
		var paddleW = 5;
		var paddleH = 20;
		
		var dx=5;
		var dy=5;
		
		function log( text ) {
			$log = $('#log');
			//Add text to log
			$log.append(($log.val()?"\n":'')+text);
			//Autoscroll
			$log[0].scrollTop = $log[0].scrollHeight - $log[0].clientHeight;
		}
		
		function ProcessPayLoad(text)
		{
			log(text);
			var xP;
			var yP;
			var pLoad = text.split(":").pop();
			
			var index;
			for(index = 0; index < pLoad.length; index++)
			{
				var temp = pLoad.charAt(index);
				if(temp == ",")
				{
					xP = pLoad.substring(0,index);
					yP = pLoad.substring(index + 1,pLoad.length);
				}
			}
			updateBall(parseInt(xP),parseInt(yP));
		}
		function updateBall(xPos,yPos)
		{
			xBall = xPos;
			yBall = yPos;
		}
		function send( text ) {
			Server.send( 'message', text );
		}

        function connect(){
            log('Connecting...');
			Server = new FancyWebSocket('ws://' + '127.0.0.1:8082');
			
			$('#message').keypress(function(e) {
				if ( e.keyCode == 13 && this.value ) {
					log( 'You: ' + this.value );
					send( this.value );
					$(this).val('');
				}
			});
		function disconnect()
		{
			log('Disconnected from server');
			Server.disconnect();
		}
		
			//Let the user know we're connected
			Server.bind('open', function() {
                document.getElementById("cntBtn").disabled = true;
				log( "Connected." );
				uName = document.getElementById("name").value;
				log("Username: " + uName);
				send("Name:" + uName.toString());
			});

			//OH NOES! Disconnection occurred.
			Server.bind('close', function( data ) {
                document.getElementById("dcBtn").disabled = false;
				log( "Disconnected." );
			});

			//Log any messages sent from server
			Server.bind('message', function( payload ) 
			{
				if(payload.substring(0,8) == "Welcome!")
				{
					log( payload );
				}
				//log(payload);
				//slice payload to get info for gamestate
				if(payload.substring(0,4) == "Game")
					ProcessPayLoad(payload);
			});

			Server.connect();
        }
		function init()
		{
			context= myCanvas.getContext('2d');
			draw();
			return setInterval(draw,10);
		}

		function draw()
		{
			context.clearRect(0,0,500,500);
			context.beginPath();
			context.fillStyle="#0000ff";
			// Draws a circle of radius 20 at the coordinates 100,100 on the canvas
			context.arc(xBall,yBall,2,0,Math.PI*2,true);
			context.rect(xPaddle,yPaddle,paddleW,paddleH);
			context.closePath();
			context.fill();
		}		
		
		function doKeyDown(evt)
		{
			switch (evt.keyCode) 
			{
			case 87:  /* W was pressed */
				if (yPaddle - dy >= 0)
				{ 
					yPaddle -= dy;
				}
				break;
			case 83:  /* S was pressed */
				if (yPaddle + dy <= 480)
				{ 
					yPaddle += dy;
				}
				break;
			}
			Server.send("Position:" + xPaddle.toString() + "," + yPaddle.toString());
		}
		window.addEventListener('keydown',doKeyDown,true);
	</script>
</head>

<body onload = "init();">
<div id = 'container'>
	<div id='body1'>
        UserName: <input type='text' id='name' name='name'>
        <button type="button" id='cntBtn' onclick="connect();">Connect</button>
		<button type="button" id='dcBtn' onclick="disconnect();">Disconnect</button>
		<textarea id='log' name='log' readonly='readonly'></textarea><br/>
		<input type='text' id='message' name='message' />
	</div>
	<div id ='body2'>
		<div class ="ball" id = "ball"></div>
		<div class ="paddle" id = "bottomPaddle"></div>
	</div>
	<p id = "demo"></p>
	<button id = "payload" onclick="myFunction()"> Print payload</button>
</div>
<canvas id = "myCanvas" width="500" height="500">
</canvas>
</body>

</html>
